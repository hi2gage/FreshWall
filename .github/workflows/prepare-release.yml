name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - custom
      custom_version:
        description: 'Custom version (only used if "custom" is selected)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout staging
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current version
        id: get_version
        run: |
          CURRENT_VERSION=$(git tag --list --sort=-version:refname | head -1 | sed 's/^v//' || echo "1.0.0")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Current version: $CURRENT_VERSION"

      - name: Calculate new version
        id: calc_version
        run: |
          CURRENT="${{ steps.get_version.outputs.current_version }}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case "${{ github.event.inputs.version_bump }}" in
            patch)
              NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH+1))"
              ;;
            minor)
              NEW_VERSION="${MAJOR}.$((MINOR+1)).0"
              ;;
            major)
              NEW_VERSION="$((MAJOR+1)).0.0"
              ;;
            custom)
              NEW_VERSION="${{ github.event.inputs.custom_version }}"
              ;;
          esac

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ New version: $NEW_VERSION"

      - name: Create release branch
        id: create_branch
        run: |
          RELEASE_BRANCH="release/v${{ steps.calc_version.outputs.new_version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$RELEASE_BRANCH"
          echo "release_branch=$RELEASE_BRANCH" >> $GITHUB_OUTPUT

      - name: Update version in xcconfig
        run: |
          NEW_VERSION="${{ steps.calc_version.outputs.new_version }}"
          BUILD_NUMBER=$(date +%Y%m%d%H%M)
          XCCONFIG_FILE="App/FreshWall/Configurations/Base.xcconfig"

          sed -i "s/IDENTITY_VERSION = .*/IDENTITY_VERSION = $NEW_VERSION/" "$XCCONFIG_FILE"
          sed -i "s/IDENTITY_BUILD = .*/IDENTITY_BUILD = $BUILD_NUMBER/" "$XCCONFIG_FILE"

          echo "build_number=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "âœ… Updated version to $NEW_VERSION and build to $BUILD_NUMBER"

      - name: Commit and push changes
        run: |
          git add .
          git commit -m "Bump version to v${{ steps.calc_version.outputs.new_version }}

          ðŸ¤– Generated by GitHub Actions"
          git push origin ${{ steps.create_branch.outputs.release_branch }}

      - name: Create and push tag
        run: |
          git tag "v${{ steps.calc_version.outputs.new_version }}"
          git push origin "v${{ steps.calc_version.outputs.new_version }}"

      - name: Create PR to staging
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base staging \
            --head ${{ steps.create_branch.outputs.release_branch }} \
            --title "Release v${{ steps.calc_version.outputs.new_version }}" \
            --body "## Release v${{ steps.calc_version.outputs.new_version }}

          Version bump and release preparation.

          ### Summary
          - Version: ${{ steps.calc_version.outputs.new_version }}
          - Build: ${{ env.build_number }}
          - Tag: v${{ steps.calc_version.outputs.new_version }}

          ### Pre-merge Checklist
          - [ ] Version numbers updated correctly
          - [ ] Tests passing
          - [ ] Ready for staging deployment

          ðŸ¤– Generated by GitHub Actions"

      - name: Create summary
        run: |
          echo "## ðŸŽ‰ Release v${{ steps.calc_version.outputs.new_version }} Prepared" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.calc_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build:** ${{ env.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ steps.create_branch.outputs.release_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** v${{ steps.calc_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review and merge the PR to staging" >> $GITHUB_STEP_SUMMARY
          echo "2. After staging tests pass, the auto-promote workflow will create PR to main" >> $GITHUB_STEP_SUMMARY
          echo "3. Merge to main for production deployment" >> $GITHUB_STEP_SUMMARY

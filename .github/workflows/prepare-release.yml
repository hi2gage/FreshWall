name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - custom
      custom_version:
        description: 'Custom version (only used if "custom" is selected)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout staging
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current version
        id: get_version
        run: |
          CURRENT_VERSION=$(git tag --list --sort=-version:refname | head -1 | sed 's/^v//' || echo "1.0.0")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Current version: $CURRENT_VERSION"

      - name: Calculate new version
        id: calc_version
        run: |
          CURRENT="${{ steps.get_version.outputs.current_version }}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case "${{ github.event.inputs.version_bump }}" in
            patch)
              NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH+1))"
              ;;
            minor)
              NEW_VERSION="${MAJOR}.$((MINOR+1)).0"
              ;;
            major)
              NEW_VERSION="$((MAJOR+1)).0.0"
              ;;
            custom)
              NEW_VERSION="${{ github.event.inputs.custom_version }}"
              ;;
          esac

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ New version: $NEW_VERSION"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update version in xcconfig
        run: |
          NEW_VERSION="${{ steps.calc_version.outputs.new_version }}"
          BUILD_NUMBER=$(date +%Y%m%d%H%M)
          XCCONFIG_FILE="App/FreshWall/Configurations/Base.xcconfig"

          sed -i "s/IDENTITY_VERSION = .*/IDENTITY_VERSION = $NEW_VERSION/" "$XCCONFIG_FILE"
          sed -i "s/IDENTITY_BUILD = .*/IDENTITY_BUILD = $BUILD_NUMBER/" "$XCCONFIG_FILE"

          echo "build_number=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "âœ… Updated version to $NEW_VERSION and build to $BUILD_NUMBER"

      - name: Commit and push to staging
        run: |
          git add .
          git commit -m "Bump version to v${{ steps.calc_version.outputs.new_version }}

          ðŸ¤– Generated by GitHub Actions"
          git push origin staging
          echo "âœ… Pushed to staging"

      - name: Create summary
        run: |
          echo "## ðŸŽ‰ Version Bumped on Staging!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.calc_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build:** ${{ env.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What Happened" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Version bumped and pushed to staging" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Auto-promote workflow will create staging â†’ main PR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review and merge the auto-created staging â†’ main PR" >> $GITHUB_STEP_SUMMARY
          echo "2. Tag and release will be auto-created when merged to main" >> $GITHUB_STEP_SUMMARY

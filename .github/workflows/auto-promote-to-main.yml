name: Auto-create PR to Main

on:
  pull_request:
    types: [closed]
    branches:
      - staging

jobs:
  create-promotion-pr:
    # Only run if the PR was actually merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: staging

      - name: Get commits since last main merge
        id: get-commits
        run: |
          git fetch origin main
          COMMITS=$(git log origin/main..origin/staging --pretty=format:"- %s (%h)" --no-merges | head -20)
          if [ -z "$COMMITS" ]; then
            COMMITS="No new commits"
          fi
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if a promotion PR already exists
          EXISTING_PR=$(gh pr list --base main --head staging --state open --json number --jq '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "Promotion PR already exists: #$EXISTING_PR"
            exit 0
          fi

          # Create the PR (without labels to avoid errors if they don't exist)
          PR_URL=$(gh pr create \
            --base main \
            --head staging \
            --title "üöÄ Promote staging to production" \
            --body "## Automatic Promotion PR

          This PR was automatically created after merging changes to \`staging\`.

          ### Merged PR
          **${{ github.event.pull_request.title }}** (#${{ github.event.pull_request.number }})
          by @${{ github.event.pull_request.user.login }}

          ### Changes to be promoted
          ${{ steps.get-commits.outputs.commits }}

          ### Checklist before merging
          - [ ] Staging environment tested and working
          - [ ] No breaking changes
          - [ ] Database migrations completed (if any)
          - [ ] Ready for production deployment

          ---

          **To enable auto-merge:** Add the \`ready-to-merge\` label to this PR.

          **After merging this PR:**
          - Production Firebase Functions will need to be deployed: \`firebase deploy --only functions --project production\`
          - iOS app may need a new build/release
          - Vercel will auto-deploy to production

          ü§ñ Auto-generated by GitHub Actions" \
            --label "production,auto-generated")

          # Extract PR number
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "‚úÖ Created PR #$PR_NUMBER"
          echo "‚è∏Ô∏è  Auto-merge NOT enabled - add 'ready-to-merge' label to enable"

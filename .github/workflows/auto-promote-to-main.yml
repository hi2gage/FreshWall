name: Auto-create PR to Main

on:
  pull_request:
    types: [closed]
    branches:
      - staging

jobs:
  create-promotion-pr:
    # Only run if the PR was actually merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper comparison

      - name: Get commits since last main merge
        id: get-commits
        run: |
          # Get the commit messages since main
          COMMITS=$(git log origin/main..staging --pretty=format:"- %s (%h)" --no-merges)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: staging
          base: main
          title: "ðŸš€ Promote staging to production"
          body: |
            ## Automatic Promotion PR

            This PR was automatically created after merging changes to `staging`.

            ### Merged PR
            **${{ github.event.pull_request.title }}** (#${{ github.event.pull_request.number }})
            by @${{ github.event.pull_request.user.login }}

            ### Changes to be promoted
            ${{ steps.get-commits.outputs.commits }}

            ### Checklist before merging
            - [ ] Staging environment tested and working
            - [ ] No breaking changes
            - [ ] Database migrations completed (if any)
            - [ ] Ready for production deployment

            ---

            **After merging this PR:**
            - Production Firebase Functions will need to be deployed: `firebase deploy --only functions --project production`
            - iOS app may need a new build/release
            - Vercel will auto-deploy to production

            ðŸ¤– Auto-generated by GitHub Actions
          labels: |
            production
            auto-generated
          draft: false

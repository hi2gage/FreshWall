name: Firebase Production Deploy

on:
  push:
    tags:
      - 'firebase/**'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      functions: ${{ steps.changes.outputs.functions }}
      firestore: ${{ steps.changes.outputs.firestore }}
      extensions: ${{ steps.changes.outputs.extensions }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            functions:
              - 'Firebase/functions/**'
            firestore:
              - 'Firebase/firestore.rules'
              - 'Firebase/firestore.indexes.json'
            extensions:
              - 'Firebase/extensions/**'

  deploy:
    needs: changes
    if: startsWith(github.ref, 'refs/tags/firebase/') && (needs.changes.outputs.functions == 'true' || needs.changes.outputs.firestore == 'true' || needs.changes.outputs.extensions == 'true')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: Firebase/functions/package-lock.json

      - name: Cache Firebase Functions dependencies
        uses: actions/cache@v3
        with:
          path: Firebase/functions/node_modules
          key: ${{ runner.os }}-functions-${{ hashFiles('Firebase/functions/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-functions-

      - name: Create Firebase cache directory
        run: mkdir -p ~/.cache/firebase

      - name: Cache Firebase CLI
        uses: actions/cache@v3
        with:
          path: ~/.cache/firebase
          key: ${{ runner.os }}-firebase-cli
          restore-keys: |
            ${{ runner.os }}-firebase-

      - name: Install dependencies
        run: |
          cd Firebase/functions
          npm ci

      - name: Build functions
        if: needs.changes.outputs.functions == 'true'
        run: |
          cd Firebase/functions
          npm run build

      - name: Setup Firebase CLI
        run: npm install -g firebase-tools

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Deploy Functions
        if: needs.changes.outputs.functions == 'true'
        run: |
          cd Firebase
          firebase deploy --only functions

      - name: Deploy Firestore Rules
        if: needs.changes.outputs.firestore == 'true'
        run: |
          cd Firebase
          firebase deploy --only firestore

      - name: Deploy Extensions
        if: needs.changes.outputs.extensions == 'true'
        run: |
          cd Firebase
          firebase deploy --only extensions

  notify:
    needs: [changes, deploy]
    if: always() && startsWith(github.ref, 'refs/tags/firebase/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deployment Summary
        run: |
          echo "## Firebase Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Functions: ${{ needs.changes.outputs.functions == 'true' && 'âœ… Deployed' || 'â­ï¸ Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Firestore: ${{ needs.changes.outputs.firestore == 'true' && 'âœ… Deployed' || 'â­ï¸ Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Extensions: ${{ needs.changes.outputs.extensions == 'true' && 'âœ… Deployed' || 'â­ï¸ Skipped' }}" >> $GITHUB_STEP_SUMMARY

      - name: Send Telegram notification
        if: needs.deploy.result == 'success'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN_PRODUCTION }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID_PRODUCTION }}
        run: |
          # Get commit info
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          COMMIT_MSG=$(git log -1 --pretty=format:'%s' "$COMMIT_SHA")
          AUTHOR="${{ github.actor }}"

          # Build components list
          COMPONENTS=""
          if [[ "${{ needs.changes.outputs.functions }}" == "true" ]]; then
            COMPONENTS="Functions"
          fi
          if [[ "${{ needs.changes.outputs.firestore }}" == "true" ]]; then
            if [[ -n "$COMPONENTS" ]]; then
              COMPONENTS+=", "
            fi
            COMPONENTS+="Firestore Rules"
          fi
          if [[ "${{ needs.changes.outputs.extensions }}" == "true" ]]; then
            if [[ -n "$COMPONENTS" ]]; then
              COMPONENTS+=", "
            fi
            COMPONENTS+="Extensions"
          fi

          # Get tag name
          TAG_NAME="${GITHUB_REF#refs/tags/}"

          # Build message
          MESSAGE="ðŸš€ <b>Production Deployment Complete</b>%0A%0A"
          MESSAGE+="<b>Environment:</b> Production%0A"
          MESSAGE+="<b>Tag:</b> ${TAG_NAME}%0A"
          MESSAGE+="<b>Deployed by:</b> @${AUTHOR}%0A"
          MESSAGE+="<b>Components:</b> ${COMPONENTS}%0A%0A"
          MESSAGE+="<b>Commit:</b> ${COMMIT_SHORT}%0A"
          MESSAGE+="<b>Message:</b> ${COMMIT_MSG}%0A%0A"
          MESSAGE+="ðŸ”— <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View deployment</a>"

          # Send to Telegram
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview="true" \
            -d text="${MESSAGE}"